{% extends "base.twig" %}

{% block title %}Cart{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Your Cart</h1>
    {% if cart.items %}
    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart.items %}
            <tr>
                <td>{{ item.name }}</td>
                <td>${{ item.price / 100 }}</td>
                <td>{{ item.qty }}</td>
                <td>${{ (item.price * item.qty) / 100 }}</td>
                <td>
                    <button class="btn btn-sm btn-danger remove-from-cart" data-product-id="{{ item.product_id }}" data-current-qty="{{ item.qty }}">Remove</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <th colspan="3">Total Items: {{ cart.totals.items }}</th>
                <th>Total Amount: ${{ cart.totals.amount / 100 }}</th>
                <th></th>
            </tr>
        </tfoot>
    </table>
    <a href="/checkout" class="btn btn-primary">Checkout</a>
    {% else %}
    <p>Your cart is empty.</p>
    {% endif %}
    <a href="/products" class="btn btn-secondary">Continue Shopping</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.remove-from-cart').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const productId = this.getAttribute('data-product-id');
            const currentQty = parseInt(this.getAttribute('data-current-qty'));
            const newQty = Math.max(0, currentQty - 1);
            fetch('/cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: parseInt(productId), qty: newQty })
            })
            .then(response => response.json())
            .then(data => {
                if (data.cart_id) {
                    location.reload(); // Reload to update cart accurately
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
});
</script>
{% endblock %}
